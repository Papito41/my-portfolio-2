<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Image Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-900 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-xl p-8 bg-gray-800 rounded-2xl shadow-xl border border-gray-700/50">
        <h1 class="text-3xl font-bold text-blue-400 text-center mb-2">Image Generator</h1>
        <p class="text-gray-400 text-center mb-6">
            Describe the image you want to create and click "Generate".
        </p>

        <div class="flex flex-col md:flex-row gap-4 mb-6">
            <input
                id="promptInput"
                type="text"
                placeholder="e.g., A futuristic city at sunset, digital art"
                class="flex-grow px-4 py-3 bg-gray-700 border border-gray-600 rounded-xl text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200"
            />
            <button
                id="generateButton"
                onclick="generateImage()"
                class="px-6 py-3 font-semibold text-white bg-blue-600 rounded-xl shadow-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors duration-200"
            >
                Generate
            </button>
        </div>

        <div id="loading" class="hidden text-center">
            <div class="flex justify-center items-center mb-4">
                <svg class="animate-spin -ml-1 mr-3 h-8 w-8 text-blue-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.965l3-2.674z"></path>
                </svg>
                <span class="text-lg text-gray-400">Generating image...</span>
            </div>
        </div>

        <div id="imageContainer" class="mt-6 flex justify-center hidden">
            <img id="generatedImage" class="rounded-xl shadow-2xl max-w-full h-auto border border-gray-700">
        </div>

        <p id="errorMessage" class="hidden mt-4 text-center text-red-400 text-sm"></p>
    </div>

    <script>
        // The API key is provided automatically by the canvas environment.
        const apiKey = ""; 

        async function generateImage() {
            const prompt = document.getElementById('promptInput').value.trim();
            const loadingIndicator = document.getElementById('loading');
            const imageContainer = document.getElementById('imageContainer');
            const generatedImage = document.getElementById('generatedImage');
            const errorMessage = document.getElementById('errorMessage');
            const generateButton = document.getElementById('generateButton');

            // Clear previous results
            generatedImage.src = '';
            imageContainer.classList.add('hidden');
            errorMessage.classList.add('hidden');

            if (!prompt) {
                errorMessage.textContent = 'Please enter a description for the image.';
                errorMessage.classList.remove('hidden');
                return;
            }

            // Show loading state and disable button
            loadingIndicator.classList.remove('hidden');
            generateButton.disabled = true;

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;
            const payload = {
                instances: { prompt: prompt },
                parameters: { "sampleCount": 1 }
            };

            try {
                let response = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error.message || 'Failed to generate image.');
                }
                
                const result = await response.json();
                
                if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                    const base64Data = result.predictions[0].bytesBase64Encoded;
                    const imageUrl = `data:image/png;base64,${base64Data}`;
                    generatedImage.src = imageUrl;
                    imageContainer.classList.remove('hidden');
                } else {
                    throw new Error('No image data received.');
                }

            } catch (error) {
                errorMessage.textContent = `Error: ${error.message}`;
                errorMessage.classList.remove('hidden');
            } finally {
                // Hide loading state and re-enable button
                loadingIndicator.classList.add('hidden');
                generateButton.disabled = false;
            }
        }

        async function fetchWithRetry(url, options, maxRetries = 3) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status !== 429) {
                        return response;
                    }
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(res => setTimeout(res, delay));
                } catch (error) {
                    // Re-throw if it's the last attempt
                    if (i === maxRetries - 1) throw error;
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(res => setTimeout(res, delay));
                }
            }
            throw new Error("Max retries exceeded");
        }
    </script>
</body>
</html>
